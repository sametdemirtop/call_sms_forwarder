<!DOCTYPE html>
<html>
<head>
  <base href="$FLUTTER_BASE_HREF">
  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="description" content="Call SMS Forwarder">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="Call SMS Forwarder">
  <link rel="apple-touch-icon" href="icons/Icon-192.png">
  <link rel="icon" type="image/png" href="favicon.png"/>
  <title>Call SMS Forwarder</title>
  <link rel="manifest" href="manifest.json">
  <script>
    var serviceWorkerVersion = null;
  </script>
  <script src="flutter_bootstrap.js" async></script>
</head>
<body>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-messaging-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
  
  <script>
    // Firebase yapÄ±landÄ±rmasÄ±
    const firebaseConfig = {
      apiKey: "AIzaSyBgNNwWzvxdwH1APedg9mhpq1xX98eLzWA",
      authDomain: "chat-cf257.firebaseapp.com",
      projectId: "chat-cf257",
      storageBucket: "chat-cf257.appspot.com",
      messagingSenderId: "857751704265",
      appId: "1:857751704265:web:99ca42ef6d0a11f3fd3318",
      measurementId: "G-TFHMNBNYYC"
    };

    // Firebase'i baÅŸlat
    firebase.initializeApp(firebaseConfig);

    // Push Notification Kurulum (Manuel - Butona tÄ±klandÄ±ÄŸÄ±nda Ã§alÄ±ÅŸÄ±r)
    window.setupPushNotifications = async function() {
      try {
        console.log('ğŸ”” Push notification kurulumu baÅŸlÄ±yor...');
        
        // iOS kontrolÃ¼
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        const isStandalone = window.navigator.standalone || window.matchMedia('(display-mode: standalone)').matches;
        
        console.log('ğŸ“± Cihaz: iOS=' + isIOS + ', Standalone=' + isStandalone);
        
        // iOS ve standalone deÄŸilse uyar
        if (isIOS && !isStandalone) {
          alert('ğŸ“± iPhone\'da bildirim almak iÃ§in:\n\n1. Safari\'de PaylaÅŸ butonuna bas\n2. "Ana Ekrana Ekle" seÃ§\n3. UygulamayÄ± Ana Ekrandan aÃ§\n4. Tekrar bu butona tÄ±kla');
          return false;
        }
        
        // Notification API kontrolÃ¼
        if (!('Notification' in window)) {
          alert('âš ï¸ Bu tarayÄ±cÄ± bildirimleri desteklemiyor.');
          return false;
        }

        // ReddedilmiÅŸ izin kontrolÃ¼
        if (Notification.permission === 'denied') {
          alert('âŒ Bildirim izni reddedilmiÅŸ.\n\nTarayÄ±cÄ± ayarlarÄ±ndan bu site iÃ§in bildirimlere izin verin.');
          return false;
        }

        // Service Worker kaydÄ±
        if ('serviceWorker' in navigator) {
          try {
            const registration = await navigator.serviceWorker.register('/firebase-messaging-sw.js');
            console.log('âœ… Service Worker registered:', registration);
          } catch (swError) {
            console.error('Service Worker hatasÄ±:', swError);
          }
        }

        // Ä°zin yoksa iste, varsa direkt devam et
        let permission = Notification.permission;
        if (permission === 'default') {
          permission = await Notification.requestPermission();
          console.log('ğŸ“± Notification permission:', permission);
        } else {
          console.log('ğŸ“± Notification permission already:', permission);
        }

        if (permission === 'granted') {
          const messaging = firebase.messaging();
          
          // FCM token al
          const token = await messaging.getToken({
            vapidKey: 'BHV2_wKVNSDtZXdT4xcf1binYUj8i-1u9ePROVWr7yLYpu4Y6zIP_3ZludyprDMCCyz6YC3Nlg3lFq9bLABtahw'
          });

          if (token) {
            console.log('ğŸ”‘ FCM Token:', token);
            
            // Token'Ä± Firestore'a kaydet
            const db = firebase.firestore();
            await db.collection('fcm_tokens').doc(token).set({
              token: token,
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              platform: isIOS && isStandalone ? 'ios_pwa' : 'web',
              userAgent: navigator.userAgent,
              isIOS: isIOS,
              isStandalone: isStandalone
            });
            
            console.log('âœ… FCM Token Firestore\'a kaydedildi!');
            alert('ğŸ‰ Bildirimler aktif!\n\nToken baÅŸarÄ±yla kaydedildi.');
            return true;
          } else {
            alert('âš ï¸ Token alÄ±namadÄ±. LÃ¼tfen tekrar deneyin.');
            return false;
          }
        } else {
          alert('âŒ Bildirim izni verilmedi.\n\nBildirimleri daha sonra aktifleÅŸtirebilirsiniz.');
        }
        return false;
      } catch (error) {
        console.error('âŒ Push notification setup error:', error);
        alert('âš ï¸ Bildirim kurulumu baÅŸarÄ±sÄ±z:\n' + error.message);
        return false;
      }
    };

    // Manuel Ã§aÄŸrÄ± iÃ§in hazÄ±r (otomatik Ã§alÄ±ÅŸtÄ±rma yok)
    console.log('âœ… Push notification fonksiyonu hazÄ±r. Manuel aktifleÅŸtirme iÃ§in butona tÄ±klayÄ±n.');
  </script>
</body>
</html>
